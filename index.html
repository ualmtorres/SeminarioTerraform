<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.22">
<meta name="author" content="Cloud Computing - Máster en Tecnologías y Aplicaciones en Ingeniería Informática">
<title>Despliegue de infraestructura cloud con Terraform</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Despliegue de infraestructura cloud con Terraform</h1>
<div class="details">
<span id="author" class="author">Cloud Computing - Máster en Tecnologías y Aplicaciones en Ingeniería Informática</span><br>
<span id="revdate">José Joaquín Cañadas y Manuel Torres &lt;jjcanada@ual.es&gt; &lt;mtorres@ual.es&gt;</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#_resumen">Resumen</a></li>
<li><a href="#_introducción">1. Introducción</a></li>
<li><a href="#_terraform">2. Terraform</a>
<ul class="sectlevel2">
<li><a href="#_instalación">2.1. Instalación</a></li>
<li><a href="#_sintaxis_de_los_archivos">2.2. Sintaxis de los archivos</a></li>
<li><a href="#_recursos_y_módulos">2.3. Recursos y módulos</a></li>
<li><a href="#_providers">2.4. Providers</a></li>
<li><a href="#_variables">2.5. Variables</a></li>
<li><a href="#_archivo_de_estado">2.6. Archivo de estado</a></li>
<li><a href="#_gestión_de_la_infraestructura">2.7. Gestión de la infraestructura</a></li>
</ul>
</li>
<li><a href="#_despliegue_en_openstack">3. Despliegue en OpenStack</a>
<ul class="sectlevel2">
<li><a href="#_configuración_del_provider">3.1. Configuración del provider</a></li>
<li><a href="#_inicializar_el_provider">3.2. Inicializar el provider</a></li>
<li><a href="#_despliegue_de_una_instancia">3.3. Despliegue de una instancia</a></li>
<li><a href="#_modificar_el_despliegue">3.4. Modificar el despliegue</a></li>
<li><a href="#_ejecutar_un_script_de_inicialización">3.5. Ejecutar un script de inicialización</a></li>
<li><a href="#_archivos_de_plantilla">3.6. Archivos de plantilla</a></li>
<li><a href="#_ejemplo_completo">3.7. Ejemplo completo</a></li>
</ul>
</li>
<li><a href="#_despliegue_en_google_cloud">4. Despliegue en Google Cloud</a>
<ul class="sectlevel2">
<li><a href="#_crear_una_clave_para_la_cuenta_de_servicio">4.1. Crear una clave para la Cuenta de servicio</a></li>
<li><a href="#_configuración_del_provider_2">4.2. Configuración del provider</a></li>
<li><a href="#_inicializar_el_provider_2">4.3. Inicializar el provider</a></li>
<li><a href="#_configuración_de_la_red">4.4. Configuración de la red</a></li>
<li><a href="#_despliegue_de_una_instancia_2">4.5. Despliegue de una instancia</a></li>
<li><a href="#_modificar_el_despliegue_2">4.6. Modificar el despliegue</a></li>
<li><a href="#_creación_de_una_instancia_con_una_dirección_ip_estática">4.7. Creación de una instancia con una dirección IP estática</a></li>
<li><a href="#_ejecutar_un_script_de_inicialización_2">4.8. Ejecutar un script de inicialización</a></li>
</ul>
</li>
<li><a href="#_despliegue_en_microsoft_azure">5. Despliegue en Microsoft Azure</a>
<ul class="sectlevel2">
<li><a href="#_autenticación_en_azure">5.1. Autenticación en Azure</a></li>
<li><a href="#_configuración_del_provider_3">5.2. Configuración del provider</a></li>
<li><a href="#_inicializar_el_provider_3">5.3. Inicializar el provider</a></li>
<li><a href="#_creación_de_un_grupo_de_recursos">5.4. Creación de un grupo de recursos</a></li>
<li><a href="#_configuración_de_la_red_2">5.5. Configuración de la red</a></li>
<li><a href="#_creación_de_una_instancia">5.6. Creación de una instancia</a></li>
<li><a href="#_recursos_de_interés">5.7. Recursos de interés</a></li>
</ul>
</li>
<li><a href="#_conclusiones">6. Conclusiones</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/di.png" alt="di">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen">Resumen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En este tutorial se muestra el uso de una herramienta como Terraform para construir y modificar infraestructura cloud mediante código. Se estudiarán casos de uso en OpenStack y Google Cloud.</p>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Conocer el papel de la Infraestructura como código en la cultura DevOps.</p>
</li>
<li>
<p>Entender la utilidad y potencia de la Infraestructura como código.</p>
</li>
<li>
<p>Inicializar un proveedor cloud en Terraform.</p>
</li>
<li>
<p>Desplegar infraestructura en OpenStack y Google Cloud.</p>
</li>
<li>
<p>Inicializar las máquinas virtuales en el momento de su creación.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Disponible el <a href="https://github.com/ualmtorres/terraform-examples.git" target="blank">repositorio</a> usado en este tutorial.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introducción">1. Introducción</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Desde hace un tiempo se oye hablar mucho de <a href="https://en.wikipedia.org/wiki/DevOps" target="blank">DevOps</a>. Se trata de una fusión que combina las áreas de:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Desarrollo</p>
</li>
<li>
<p>Operaciones</p>
</li>
<li>
<p>Control de calidad</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Es una extensión natural de metodologías <a href="https://en.wikipedia.org/wiki/Agile_software_development" target="blank">Agile</a> y es habitual el uso de los <a href="https://medium.com/@seanguthrie/devops-principles-the-cams-model-9687591ca37a" target="blank">principios CAMS</a>, cuyas siglas vienen de:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>C</strong>ultura relacionada con comunicación humana, procesos y herramientas</p>
</li>
<li>
<p><strong>A</strong>utomatización de procesos</p>
</li>
<li>
<p><strong>M</strong>onitorización</p>
</li>
<li>
<p><strong>S</strong>haring feedback, buenas prácticas y conocimiento</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En DevOps son habituales las prácticas siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Planificación ágil</p>
</li>
<li>
<p>Despliegue continuo (<em>CI/CD</em>). La subida de cambios al repositorio de código desencadena la ejecución de pruebas automatizadas que finalmente realizan el despliegue de los cambios tras superarse las pruebas.</p>
</li>
<li>
<p>Infraestructura como código (<em>Infrastructure as Code</em>). Se trata del desarrollo de scripts para las tareas de despliegue y gestión de la infraestructura</p>
</li>
<li>
<p>Contenedorización. Combinada con la Infraestructura como código, permite el despliegue instantáneo de aplicaciones en contenedores.</p>
</li>
<li>
<p>Microservicios. Desarrollo de aplicaciones como un conjunto de servicios independientes. Cada servicio se despliega de forma independiente lo que facilita la escalabilidad y la actualización de los servicios.</p>
</li>
<li>
<p>Infraestructura cloud. Favorece el despliegue, la disponibilidad y la automatización.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En esta asignatura ya hemos tratado las prácticas de <a href="https://ualmtorres.github.io/AsignaturaCloudComputing/#_tema_2_infraestructura_de_cloud_computing" target="blank">Infraestructura cloud</a> y de <a href="https://ualmtorres.github.io/AsignaturaCloudComputing/#_tema_4_servicios_de_contenedores" target="blank">Contenedorización</a>. En este tema nos centraremos en la Infraestructura como código, a la que podríamos caracterizar de esta forma:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Uso de scripts para configurar de forma automática el entorno (redes, máquinas virtuales, volúmenes, …) con independencia de su estado inicial.</p>
</li>
<li>
<p>Versionado y desarrollo colaborativo del código de la infraestructura mediante sistemas de control de versiones.</p>
</li>
<li>
<p>Infraestructura repetible.</p>
</li>
<li>
<p>Evita errores humanos.</p>
</li>
<li>
<p>Se especifica el estado de lo que se quiere.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Actualmente, existen varias propuestas para hacer Infraestructura como código. Hay algunas que son específicas de un proveedor, como <a href="https://aws.amazon.com/es/cloudformation/" target="blank">AWS CloudFormation</a> y <a href="https://azure.microsoft.com/es-es/get-started/azure-portal/resource-manager" target="blank">Azure Resource Manager</a>. Otras son más genéricas y permiten trabajar con varios proveedores, como <a href="https://www.terraform.io/" target="blank">Terraform</a>, <a href="https://www.pulumi.com/" target="blank">Pulumi</a> o <a href="https://www.ansible.com/" target="blank">Ansible</a>.</p>
</div>
<div class="paragraph">
<p>En este tema estudiaremos <a href="https://www.terraform.io/">Terraform</a>, una herramienta para construir, modificar y versionar infraestructura de forma segura y eficiente.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">La cultura DevOps</div>
<div class="paragraph">
<p>Si esto te parece interesante, puedes dedicar unos minutos a la lectura de estos documentos breves sobre DevOps. Presentan de forma clara y sencilla términos como <em>DevOps, Integración continua, Microservicios, &#8230;&#8203;</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-devops" target="blank">DevOps</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-continuous-integration" target="blank">Integración contínua</a>]</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-continuous-delivery" target="blank">Entrega contínua</a>]</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-devops-culture" target="blank">Cultura DevOps</a>]</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-infrastructure-as-code" target="blank">Infraestructura como código</a>]</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-are-microservices" target="blank">Microservicios</a>]</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/devops/learn/what-is-monitoring" target="blank">Monitorización</a>]</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_terraform">2. Terraform</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.terraform.io/">Terraform</a> es una herramienta para construir, modificar y versionar infraestructura de forma segura y eficiente. Es un proyecto Open Source desarrollado por <a href="https://www.hashicorp.com/about" target="blank">HashiCorp</a>, surgido en 2014. Genera un plan de ejecución (preview) indicando qué hará para conseguir el estado deseado. Si hay cambios en la configuración, Terraform detecta los cambios y crea un plan incremental para alcanzar el nuevo estado.</p>
</div>
<div class="sect2">
<h3 id="_instalación">2.1. Instalación</h3>
<div class="paragraph">
<p>La instalación de Terraform es muy sencilla. Se <a href="https://www.terraform.io/" target="blank">descarga</a> como un binario que hay que descoprimir. Luego se coloca en un directorio incluido en el PATH del sistema. Probamos su funcionamiento desde la terminal con <code>terraform</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Usage: terraform [global options] &lt;subcommand&gt; [args]

The available commands for execution are listed below.
The primary workflow commands are given first, followed by
less common or more advanced commands.

Main commands:
  init          Prepare your working directory for other commands
  validate      Check whether the configuration is valid
  plan          Show changes required by the current configuration
  apply         Create or update infrastructure
  destroy       Destroy previously-created infrastructure

All other commands:
  console       Try Terraform expressions at an interactive command prompt
  fmt           Reformat your configuration in the standard style
  force-unlock  Release a stuck lock on the current workspace
  get           Install or upgrade remote Terraform modules
  graph         Generate a Graphviz graph of the steps in an operation
  import        Associate existing infrastructure with a Terraform resource
  login         Obtain and save credentials for a remote host
  logout        Remove locally-stored credentials for a remote host
  metadata      Metadata related commands
  output        Show output values from your root module
  providers     Show the providers required for this configuration
  refresh       Update the state to match remote systems
  show          Show the current state or a saved plan
  state         Advanced state management
  taint         Mark a resource instance as not fully functional
  test          Experimental support for module integration testing
  untaint       Remove the 'tainted' state from a resource instance
  version       Show the current Terraform version
  workspace     Workspace management

Global options (use these before the subcommand, if any):
  -chdir=DIR    Switch to a different working directory before executing the
                given subcommand.
  -help         Show this help output, or the help for a specified subcommand.
  -version      An alias for the "version" subcommand.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sintaxis_de_los_archivos">2.2. Sintaxis de los archivos</h3>
<div class="paragraph">
<p>Hashicorp usa su propio lenguaje de configuración para la descripción de la infraestructura.</p>
</div>
<div class="paragraph">
<p>Los archivos Terraform se pueden escribir en dos formatos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HashiCorp Configuration Language (HCL). La extensión de los archivos es <code>.tf</code></p>
</li>
<li>
<p>JSON. La extensión de los archivos es <code>.tf.json</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El formato preferido es HCL, ya que es más legible y fácil de escribir. No obstante, el lenguaje HCL es un poco complicado y puede ser confuso al principio, especialmente si se quieren hacer bucles o condicionales.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://www.pulumi.com/">Pulumi</a>, una herramienta similar a Terraform, permite escribir la configuración en varios lenguajes de programación como Python, TypeScript, Go, &#8230;&#8203; Sin embargo, Terraform es más popular y tiene una comunidad más grande. Esto, unido a que el estado en Terraform se almacena en local de forma predeterminada, mientras que en Pulumi se almacena en la nube, hace que Pulumi pueda despertar recelos en entornos corporativos.</p>
</div>
<div class="paragraph">
<p>Puedes obtener más información en el tutorial <a href="https://ualmtorres.github.io/seminario-pulumi/">Infraestructura como código con Pulumi</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_recursos_y_módulos">2.3. Recursos y módulos</h3>
<div class="paragraph">
<p>El objetivo de Terraform es declarar <em>recursos</em>. Todas las características del lenguaje giran en torno a hacer que la definición de recursos sea más flexible y conveniente.</p>
</div>
<div class="paragraph">
<p>Los recursos puede agruparse en módulos, que crean una unidad de configuración de nivel más alto. Un recurso describe un objeto básico de infraestructura, mientras que un módulo describe un conjunto de objetos y sus relaciones para crear un sistema mayor.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Ejemplo de un recurso para crear en OpenStack una IP flotante de la red <code>externa</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">resource "openstack_networking_floatingip_v2" "tf_vm_ip" {
  pool = "externa"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Una configuración Terraform consta de un módulo raíz donde comienza la evaluación. El módulo puede contener módulos hijo que se van llamando unos a otros. La configuración más sencilla de módulo contendría sólo un archivo <code>.tf</code> (<code>main.tf</code>) aunque se recomienda una organización como la siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>main.tf</code>: Configuración de lo recursos del módulo</p>
</li>
<li>
<p><code>providers.tf</code>: Proveedor de los recursos del módulo</p>
</li>
<li>
<p><code>variables.tf</code> : Variables de entrada</p>
</li>
<li>
<p><code>terraform.tfvars</code>: Valores de las variables de entrada</p>
</li>
<li>
<p><code>output.tf</code>: Variables de salida</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>El archivo <code>terraform.tfvars</code> es opcional. Se usa para definir valores de variables de entrada. Si no se usa, se pueden definir las variables en el archivo <code>variables.tf</code>. Sin embargo, es una buena práctica usar <code>terraform.tfvars</code> para separar la configuración de la declaración de variables y dejar <code>variables.tf</code> para la declaración de variables. Además, de cara al control de versiones, se facilita la gestión de las variables de entorno, añadiendo el archivo <code>terraform.tfvars</code> al <code>.gitignore</code>. Esto evita que se suban al repositorio valores sensibles como contraseñas o claves de acceso.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ejemplo de organización:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">├── README.md
├── main.tf
├── providers.tf
├── variables.tf
├── terraform.tfvars
├── outputs.tf
├── ...
├── modules/
│   ├── moduleA/
│   │   ├── README.md
│   │   ├── main.tf
│   │   ├── providers.tf
│   │   ├── variables.tf
│   │   ├── outputs.tf
│   ├── moduleB/
│   ├── .../</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_providers">2.4. Providers</h3>
<div class="paragraph">
<p>Terraform puede crear <em>stacks</em> de infraestructura en varios proveedores. Por ejemplo, una configuración podría crear infraestructura en Google Cloud Platform y en OpenStack-DI.</p>
</div>
<div class="paragraph">
<p>Hay gran cantidad de proveedores Terraform, tanto <a href="https://www.terraform.io/docs/providers/index.html" target="blank">oficiales</a>, mantenidos por Hashicorp, (AWS, Azure, Google Cloud Platform, Heroku, Kubernetes, MongoDB Atlas, OpenStack, VMware Cloud, VMware vSphere, &#8230;&#8203;) como de la <a href="https://www.terraform.io/docs/providers/type/community-index.html" target="blank">comunidad y terceros</a> (OpenShift, Trello, Telegram, &#8230;&#8203;)</p>
</div>
</div>
<div class="sect2">
<h3 id="_variables">2.5. Variables</h3>
<div class="sect3">
<h4 id="_variables_de_entrada">2.5.1. Variables de entrada</h4>
<div class="paragraph">
<p>Las variables de entrada se usan como parámetros para los módulos. Se crean mediante bloques <code>variable</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">variable "openstack_user_name" {
    type = string
    description = "The username for the Tenant."
    default  = "mtorres" <b class="conum">(1)</b>
}

variable "security_groups" {
    type    = list(string)
    default = ["default"]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Valor por defecto. Esto es opcional y se usa si no se especifica un valor en el archivo <code>terraform.tfvars</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Las variables se usan siguiendo esta sintaxis <code>var.&lt;variable&gt;</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">provider "openstack" {
  user_name   = var.openstack_user_name <b class="conum">(1)</b>
  ....
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Uso de la variable <code>openstack_user_name</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Más información sobre la declaración, uso de variables y constructores de tipos en la <a href="https://www.terraform.io/docs/configuration/variables.html" target="blank">documentación oficial</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuración_de_variables">2.5.2. Configuración de variables</h4>
<div class="paragraph">
<p>Las variables se pueden configurar de varias formas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>En el archivo <code>variables.tf</code> con un valor por defecto.</p>
</li>
<li>
<p>En el archivo <code>terraform.tfvars</code> con un valor específico.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_declaración_de_variables_sin_valor_por_defecto">Declaración de variables sin valor por defecto</h5>
<div class="paragraph">
<p>Por ejemplo, si define una variable <code>user_name</code> en <code>variables.tf</code>, se puede configurar en <code>terraform.tfvars</code> con un valor específico.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>variables.tf</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">variable "user_name" {
  type        = string
  description = "The username for the Tenant."
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Archivo <code>terraform.tfvars</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">user_name = "mtorres"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_declaración_de_variables_con_valor_por_defecto">Declaración de variables con valor por defecto</h5>
<div class="paragraph">
<p>Si se define una variable <code>user_name</code> en <code>variables.tf</code> con un valor por defecto, se puede configurar en <code>terraform.tfvars</code> con un valor específico o dejar el valor por defecto.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>variables.tf</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">variable "user_name" {
  type        = string
  description = "The username for the Tenant."
  default     = "mtorres" <b class="conum">(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Valor por defecto</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Archivo <code>terraform.tfvars</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">user_name = "mtorres"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si se define una variable en <code>variables.tf</code> con un valor por defecto y no se configura en <code>terraform.tfvars</code>, se usará el valor por defecto. En cambio, si se configura en <code>terraform.tfvars</code>, se usará el valor específico, independientemente del valor por defecto.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_variables_de_entorno">2.5.3. Variables de entorno</h4>
<div class="paragraph">
<p>Terraform permite el uso de variables de entorno para la configuración. Se definen con la sintaxis <code>TF_VAR_&lt;variable&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, si se define una variable <code>PASSWORD</code> en Terraform, se puede acceder a ella en la shell como <code>TF_VAR_PASSWORD</code>. Terraform la reconocerá como <code>PASSWORD</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ export TF_VAR_PASSWORD=xxxx</code></pre>
</div>
</div>
<div class="paragraph">
<p>Posterirmente, se accede a la variable en Terraform como <code>var.PASSWORD</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">provider "openstack" {
  user_name   = var.openstack_user_name
  tenant_name = var.openstack_tenant_name
  password    = var.PASSWORD <b class="conum">(1)</b>
  auth_url    = var.openstack_auth_url
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Uso de la variable</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La variable <code>PASSWORD</code> no tiene por qué estar definida en el archivo <code>variables.tf</code>. Terraform la reconocerá como <code>PASSWORD</code>. Además, Terraform no la incluirá en el archivo de estado. Esto es muy útil para almacenar valores sensibles como contraseñas o claves de acceso.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>Configurar contraseñas en variables de entorno es una buena práctica de seguridad. Por contra, almacenar contraseñas en archivos de configuración es una mala práctica, ya que si se suben al repositorio de código quedan expuestas y además se almacenan en el archivo de estado de Terraform, lo que puede ser un problema de seguridad.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_variables_de_salida">2.5.4. Variables de salida</h4>
<div class="paragraph">
<p>Las variables de salida se usan para pasar valores a otros módulos o para mostrar en el CLI un resultado tras un despliegue con <code>terraform apply</code>.</p>
</div>
<div class="paragraph">
<p>Las variables de salida se definen con bloques <code>output</code> y un identificador único. Normalmente, toman como valor una expresión (p.e. una IP generada para una instancia creada).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">output tf_vm_Floating_IP {
  value      = openstack_networking_floatingip_v2.tf_vm_ip.address <b class="conum">(1)</b>
  depends_on = [openstack_networking_floatingip_v2.tf_vm_ip] <b class="conum">(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Expresión que devuelve la dirección IP de un recurso previamente creado.</p>
</li>
<li>
<p>Argumento opcional que establece una dependencia con un recurso creado.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_archivo_de_estado">2.6. Archivo de estado</h3>
<div class="paragraph">
<p>Terraform guarda la información de la infraestructura creada en un archivo de estado Terraform (<code>terraform.tfstate</code>). Este archivo se usa al ejecutar los comandos <code>terraform plan</code> o <code>terraform apply</code> para determinar los cambios a aplicar. Gracias a esto se puede:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Seguir la pista de los cambios en la infraestructura</p>
</li>
<li>
<p>Actualizar sólo los componentes necesarios</p>
</li>
<li>
<p>Eliminar componentes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Una característica muy interesante de Terraform es la idempotencia, así como la facilidad para aplicar cambios. Si volvemos a ejecutar un despliegue con <code>terraform apply</code> y no ha habido cambios en los archivos de configuración tras el último despliegue (cuyo estado quedó almacenado en el archivo <code>.tfstate</code>), el despliegue quedará intacto. Es decir, no se volverá a crear infraestructura repetida, ni se reemplazará la infraestructura creada por una nueva si no hay cambios en los archivos de configuración.</p>
</div>
<div class="paragraph">
<p>Sin embargo, si modificamos la configuración modificando los archivos Terraform estaremos indicando un nuevo estado al que queremos llegar. En este caso, al aplicar <code>terraform apply</code> sí se desplegarán los cambios realizados en la configuración. Sin embargo, sólo se desplegarán los recursos correspondientes a los cambios realizados, manteniendo intacta la configuración no modificada.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Atención al archivo de estado</div>
<div class="paragraph">
<p><strong>El archivo de estado puede contener información sensible por lo que debe quedar excluido en el sistema de control de versiones.</strong></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Recuerda incluir el archivo de estado en <a href="https://github.com/github/gitignore/blob/master/Terraform.gitignore" target="blank">.gitignore</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Además, el estado local no funciona bien en un entorno colaborativo, ya que la ejecución local almacenaría el estado en cada equipo local y no coincidirá con el estado almacenado en otro equipo de otro miembro. Si dos o más personas necesitan ejecutar la configuración Terraform, se necesita almacenar el archivo en un lugar remoto común a fin de evitar errores y no dañar la infraestructura existente.</p>
</div>
<div class="paragraph">
<p>Más información sobre <a href="https://www.terraform.io/docs/state/remote.html" target="blank">estado remoto</a> y <a href="https://www.terraform.io/docs/backends/" target="blank">configuración de backends</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Google Cloud Storage ofrece <a href="https://www.terraform.io/docs/backends/types/gcs.html" target="blank">soporte para el almacenamiento del estado de Terraform</a> con la opción de bloqueo. Crea un segmento (<em>bucket</em>) y activa el versionado de objetos para recuperación de estados anteriores ante errores accidentales.</p>
</div>
<div class="paragraph">
<p>Terraform también permite usar una base de datos PostgreSQL para el almacenamiento del estado con la opción de bloqueo. Aprovisiona una máquina virtual con SQL o usa un servicio de PostgreSQL en la nube para el almacenamiento de estado en PostgreSQL.</p>
</div>
<div class="paragraph">
<p>Actualmente. Terraform da una lista bastante amplia de backends para almacenamiento de estado</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.terraform.io/docs/backends/types/azurerm.html" target="blank">Azure Blob Storage</a></p>
</li>
<li>
<p><a href="https://www.terraform.io/docs/backends/types/consul.html" target="blank">Consul</a></p>
</li>
<li>
<p><a href="https://www.terraform.io/docs/backends/types/etcdv3.html" target="blank">etcd</a></p>
</li>
<li>
<p><a href="https://www.terraform.io/docs/backends/types/gcs.html" target="blank">Google Cloud Storage</a></p>
</li>
<li>
<p><a href="https://www.terraform.io/docs/backends/types/http.html" target="blank">cliente REST HTTP</a>. Prueba con este <a href="https://medium.com/@meson10/remote-terraform-state-server-47c481983268" target="blank">ejemplo</a> en Go MongoDB</p>
</li>
<li>
<p><a href="https://www.terraform.io/docs/backends/types/kubernetes.html" target="blank">Kuberntes Secrets</a> (Máximo 1 MB)</p>
</li>
<li>
<p><a href="https://www.terraform.io/docs/backends/types/pg.html" target="blank">PostgreSQL</a></p>
</li>
<li>
<p><a href="https://www.terraform.io/docs/backends/types/s3.html" target="blank">Amazon S3</a></p>
</li>
<li>
<p><a href="https://www.terraform.io/docs/backends/types/swift.html" target="blank">OpenStack Swift</a></p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gestión_de_la_infraestructura">2.7. Gestión de la infraestructura</h3>
<div class="paragraph">
<p>Normalmente, estos son los pasos que se deben seguir para construir, mantener y eliminar una infraestructura con Terraform.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inicializar el directorio del proyecto Terraform (<code>terraform init</code>). El comando descarga todos los componentes necesarios, incluyendo módulos y plugins. La inicialización crea un archivo <code>.terraform</code> en el directorio de trabajo con los plugins necesarios. La información necesaria sobre los plugins y proveedores a descargar se suele encontrar en el archivo <code>providers.tf</code>.</p>
</li>
<li>
<p>Crear un plan de ejecución (<code>terraform plan</code>). El comando determina las acciones necesarias para alcanzar el estado deseado especificado en los archivos de configuración (p.e. <code>main.tf</code>).</p>
</li>
<li>
<p>Crear o modificar la infraestructura (<code>terraform apply</code>). Terraform es idempotente. Al usar este comando sólo se despliegan los recursos correspondientes a los cambios que se hayan realizado en los archivos de configuración (p.e. <code>main.tf</code>), sin volver a crear lo que ya existe y no se ha modificado. Para esto, Terraform se basa en lo almacenado en los archivos de estado, que guardan la información de la infraestructura creada en el último despliegue.</p>
</li>
<li>
<p>Mostrar las variables de salida de un despliegue (<code>terraform output</code>).</p>
</li>
<li>
<p>Eliminar la infraestructura (<code>terraform destroy</code>). Se usa para eliminar la infraestructura creada.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Es posible que en algún momento se produzca un fallo en un despliegue. Por ejemplo, se realiza un despliegue de una infraestructura y se produce un error por falta de recursos. En una situación como esta, Terraform no puede deshacer los cambios realizados y quizá no pueda eliminar los recursos creados. En este caso, se puede usar el comando <code>terraform refresh</code> para actualizar el estado de la infraestructura con la información real de los recursos creados. Esto reconciliará el estado de la infraestructura con la información real de los recursos creados. Posteriormente, se puede usar <code>terraform destroy</code> para eliminar la infraestructura.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_despliegue_en_openstack">3. Despliegue en OpenStack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>El provider <a href="https://registry.terraform.io/providers/terraform-provider-openstack/openstack/latest/docs" target="blank">OpenStack</a> permite crear configuraciones Terraform para desplegar infraestructura en OpenStack. Entre los recursos que podemos gestionar están:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Instancias</p>
</li>
<li>
<p>Credenciales</p>
</li>
<li>
<p>Imágenes</p>
</li>
<li>
<p>Redes</p>
</li>
<li>
<p>Almacenamiento de bloques</p>
</li>
<li>
<p>Almacenamiento NFS</p>
</li>
<li>
<p>Balanceadores de carga</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_configuración_del_provider">3.1. Configuración del provider</h3>
<div class="paragraph">
<p>Para usarlo hay que configurar sus <a href="https://registry.terraform.io/providers/terraform-provider-openstack/openstack/latest/docs" target="blank">parámetros de acceso</a> (p.e. usuario, proyecto, endpoint, &#8230;&#8203;). Lo haremos en un archivo <code>providers.tf</code>. El archivo <code>providers.tf</code> se usa para definir y configurar los proveedores de los recursos del módulo.</p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>providers.tf</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">terraform {
  required_version = "&gt;= 0.14.0"
  required_providers {
    openstack = {
      source  = "terraform-provider-openstack/openstack"
      version = "~&gt; 1.53.0"
    }
  }
}

provider "openstack" {
  user_name   = var.openstack_user_name
  tenant_name = var.openstack_tenant_name
  password    = var.PASSWORD <b class="conum">(1)</b>
  auth_url    = var.openstack_auth_url
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La contraseña se accede a través de la variable de entorno <code>TF_VAR_PASSWORD</code> para evitar almacenarla en el archivo de configuración y en el archivo de estado. Esto es una buena práctica de seguridad.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Se usan las variables definidas en el archivo <code>variables.tf</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">variable "openstack_user_name" {
    description = "The username for the Tenant."
    default  = "your-openstack-user"
}

variable "PASSWORD" {
    description = "The user password."
}

variable "openstack_tenant_name" {
    description = "The name of the Tenant."
    default  = "your-openstack-project"
}

variable "openstack_auth_url" {
    description = "The endpoint url to connect to OpenStack."
    default  = "https://openstack.di.ual.es:5000/v3"
}

variable "openstack_keypair" {
    description = "The keypair to be used."
    default  = "your-openstack-keypair-name"
}</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Uso de variables de entorno</div>
<div class="paragraph">
<p>Para evitar introducir datos sensibles en los archivos de configuración y evitar que queden expuestos en el sistema de control de versiones es buena práctica configurar valores sensibles en variables de entorno.</p>
</div>
<div class="paragraph">
<p>El convenio de Terraform es que definamos en la shell las variables precedidas de <code>TF_VAR_</code>. Por ejemplo, definimos una variable de entorno <code>TF_VAR_PASSWORD</code> que será accedida por Terraform como <code>PASSWORD</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Nomemclatura de variables de entorno</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Variable de entorno</th>
<th class="tableblock halign-left valign-top">Variable Terraform</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TF_VAR_PASSWORD</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PASSWORD</code></p></td>
</tr>
</tfoot>
</table>
<div class="paragraph">
<p>Seguiremos estos pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configurar la variables en la shell</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ export TF_VAR_PASSWORD=xxxx</code></pre>
</div>
</div>
</li>
<li>
<p>Cargar la variable en Terraform</p>
<div class="listingblock">
<div class="title">Archivo <code>variables.tf</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">...
variable "PASSWORD" {} <b class="conum">(1)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>La variable de entorno <code>TF_VAR_PASSWORD</code> es reconocida en Terraform como <code>PASSWORD</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Usar la variable en Terraform</p>
<div class="listingblock">
<div class="title">Archivo <code>providers.tf</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">provider "openstack" {
  user_name   = var.openstack_user_name
  tenant_name = var.openstack_tenant_name
  password    = var.PASSWORD <b class="conum">(1)</b>
  auth_url    = var.openstack_auth_url
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Uso de la variable</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inicializar_el_provider">3.2. Inicializar el provider</h3>
<div class="paragraph">
<p>Para inicializar ejecutar <code>terraform init</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">terraform init

Initializing the backend...

Initializing provider plugins...
- Reusing previous version of terraform-provider-openstack/openstack from the dependency lock file
- Using previously-installed terraform-provider-openstack/openstack v1.53.0

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
(base) MacBook-Pro-de-Manuel:00-pruebas-carga manolo$ terraform init

Initializing the backend...

Initializing provider plugins...
- Finding terraform-provider-openstack/openstack versions matching "~&gt; 1.53.0"...
- Installing terraform-provider-openstack/openstack v1.53.0...
- Installed terraform-provider-openstack/openstack v1.53.0 (self-signed, key ID 4F80527A391BEFD2)

Partner and community providers are signed by their developers.
If you'd like to know more about provider signing, you can read about it here:
https://www.terraform.io/docs/cli/plugins/signing.html

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run "terraform init" in the future.

...

Terraform has been successfully initialized!

...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto creará una carpeta <code>.terraform</code> con en plugin de OpenStack instalado y disponible para ser usado en el proyecto. También crea un archivo <code>.terraform.lock.hcl</code> que registra las selecciones de proveedores realizadas. Este archivo se debe incluir en el repositorio de control de versiones para garantizar que Terraform haga las mismas selecciones por defecto cuando se ejecute <code>terraform init</code> en el futuro.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Actualización de la configuración</div>
<div class="paragraph">
<p>Con el paso del tiempo, puede que haya que actualizar la configuración de Terraform. La actualuización comprendería módulos, plugins y proveedores. Para ello, ejecutar <code>terraform init -upgrade</code> en el directorio del proyecto.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_despliegue_de_una_instancia">3.3. Despliegue de una instancia</h3>
<div class="paragraph">
<p>La creación de una instancia se realiza con <a href="https://registry.terraform.io/providers/terraform-provider-openstack/openstack/latest/docs/resources/compute_instance_v2" target="blank">openstack_compute_instance_v2</a>.</p>
</div>
<div class="paragraph">
<p>A continuación, crearemos una instancia denominada <code>tf_vm</code>. Cada recurso creado en Terraform se identifica con un nombre. En este caso, el nombre del recurso es <code>tf_vm</code>. Es el nombre que se use en <code>resource</code>, no el nombre asignado en <code>name</code>, es el que referencia al objeto <code>resource</code> creado. Esto permite tratar el recurso creado (p.e. para asignarle una dirección IP flotante, para conectarle un volumen, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>En el ejemplo siguiente se ilustra la creación de una máquina virtual, una dirección IP flotante (<a href="https://registry.terraform.io/providers/terraform-provider-openstack/openstack/latest/docs/resources/networking_floatingip_v2" target="blank"><code>openstack_networking_floatingip_v2</code></a>) y la asignación de la IP flotante a la máquina virtual creada (<a href="https://registry.terraform.io/providers/terraform-provider-openstack/openstack/latest/docs/resources/compute_floatingip_associate_v2" target="blank"><code>openstack_compute_floatingip_associate_v2</code></a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terraform" data-lang="terraform">#Crear nodo tf_vm
resource "openstack_compute_instance_v2" "tf_vm" {<b class="conum">(1)</b>
  name              = "tf_vm"
  image_name        = "jammy"
  availability_zone = "nova"
  flavor_name       = "medium"
  key_pair          = var.openstack_keypair
  security_groups   = ["default"]
  network {
    name = var.openstack_network_name <b class="conum">(2)</b>
  }
}

resource "openstack_networking_floatingip_v2" "tf_vm_ip" { <b class="conum">(3)</b>
  pool = "ext-net"
}

resource "openstack_compute_floatingip_associate_v2" "tf_vm_ip" { <b class="conum">(4)</b>
  floating_ip = openstack_networking_floatingip_v2.tf_vm_ip.address <b class="conum">(5)</b>
  instance_id = openstack_compute_instance_v2.tf_vm.id <b class="conum">(6)</b>
}

output tf_vm_Floating_IP {
  value      = openstack_networking_floatingip_v2.tf_vm_ip.address <b class="conum">(7)</b>
  depends_on = [openstack_networking_floatingip_v2.tf_vm_ip] <b class="conum">(8)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Creación de un recurso instancia (máquina virtual) en OpenStack. El objeto recurso creado es asignado a la variable <code>tf_vm</code>.</p>
</li>
<li>
<p>Red a la que se conectará la instancia creada. Usamos una variable de entrada almacenada en <code>variables.tf</code> con el nombre de la red.</p>
</li>
<li>
<p>Creación de un recurso dirección IP flotante. El objeto recurso creado es asignado a la variable <code>tf_vm_ip</code>.</p>
</li>
<li>
<p>Asociación de la IP flotante a la instancia</p>
</li>
<li>
<p>Acceso a la dirección del recurso IP flotante creado</p>
</li>
<li>
<p>Acceso al <code>id</code> la instancia creada</p>
</li>
<li>
<p>Acceso a la dirección del recurso IP flotante creado</p>
</li>
<li>
<p>Esperar a que esté creado el recurso de la IP flotante</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La creación de la instancia, igual que los demás recursos, tiene un configuración específica. En este caso, se crea una instancia con las siguientes características destacadas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Nombre <code>tf_vm</code></p>
</li>
<li>
<p>Imagen <code>jammy</code>. Así es como se conoce a la imagen de Ubuntu 22.04 en OpenStack-DI.</p>
</li>
<li>
<p>Zona de disponibilidad <code>nova</code>. Es el nombre de la zona de disponibilidad en OpenStack-DI. Una zona de disponibilidad es un conjunto de recursos de cómputo y almacenamiento que se encuentran en un solo centro de datos o en varios centros de datos cercanos.</p>
</li>
<li>
<p>Sabor <code>medium</code>. Es el tamaño de la instancia. En OpenStack-DI, el tamaño <code>medium</code> es una instancia con 2 vCPUs y 4 GB de RAM.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para desplegar la infraestructura, ejecutar <code>terraform apply</code>. Terraform mostrará un resumen de los cambios a realizar y pedirá confirmación para aplicarlos. Si la variable de entorno <code>TF_VAR_PASSWORD</code> no está definida, Terraform la solicitará. Tras confirmar, Terraform creará la infraestructura. Como resultado, se mostrará la dirección IP flotante asignada a la instancia creada.</p>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra la instancia creada en OpenStack-DI con la dirección IP flotante asignada.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/terraform-openstack-instance.png" alt="Terraform OpenStack instance">
</div>
</div>
<div class="paragraph">
<p>Si ya no necesitamos la infraestructura creada, podemos eliminarla con <code>terraform destroy</code>. Terraform mostrará un resumen de los cambios a realizar y pedirá confirmación para aplicarlos. Tras confirmar, Terraform eliminará la infraestructura.</p>
</div>
</div>
<div class="sect2">
<h3 id="_modificar_el_despliegue">3.4. Modificar el despliegue</h3>
<div class="paragraph">
<p>La modificación de un despliegue se realiza modificando los archivos de configuración Terraform y ejecutando <code>terraform apply</code>. Terraform detectará los cambios y mostrará un resumen de los cambios a realizar. Tras confirmar, Terraform aplicará los cambios.</p>
</div>
<div class="paragraph">
<p>A modo de ilustración, este ejemplo muestra cómo aplicar cambios a una configuración desplegada previamente. En este caso se trata de:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cambiar el <em>sabor</em> de la instancia desplegada.</p>
</li>
<li>
<p>Crear un volumen de 1GB (<a href="https://registry.terraform.io/providers/terraform-provider-openstack/openstack/latest/docs/resources/blockstorage_volume_v3" target="blank"><code>openstack_blockstorage_volume_v3</code></a>).</p>
</li>
<li>
<p>Conectar el volumen a la máquina virtual (<a href="https://registry.terraform.io/providers/terraform-provider-openstack/openstack/latest/docs/resources/compute_volume_attach_v2" target="blank"><code>openstack_compute_volume_attach_v2</code></a>).</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terraform" data-lang="terraform">resource "openstack_compute_instance_v2" "tf_vm" {
  name              = "tf_vm"
  image_name        = "jammy"
  availability_zone = "nova"
  flavor_name       = "large" <b class="conum">(1)</b>
  key_pair          = var.openstack_keypair
  security_groups   = ["default"]
  network {
    name = var.openstack_network_name
  }
}

...

resource "openstack_blockstorage_volume_v3" "tf_vol" { <b class="conum">(2)</b>
  name        = "tf_vol"
  description = "first test volume"
  size        = 1 <b class="conum">(3)</b>
}

resource "openstack_compute_volume_attach_v2" "va_1" { <b class="conum">(4)</b>
  instance_id = "${openstack_compute_instance_v2.tf_vm.id}" <b class="conum">(5)</b>
  volume_id   = "${openstack_blockstorage_volume_v3.tf_vol.id}" <b class="conum">(6)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Modificación del sabor de la imagen</p>
</li>
<li>
<p>Creación de un recurso volumen</p>
</li>
<li>
<p>Especificación del tamaño del volumen</p>
</li>
<li>
<p>Conexión del volumen a la instancia</p>
</li>
<li>
<p>Acceso al <code>id</code> la instancia</p>
</li>
<li>
<p>Acceso al <code>id</code> del volumen creado</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Al ejecutar con <code>terraform apply</code>, Terraform nos informará de los cambios detectados y de la nueva configuración. La nueva configuración se aplicará si confirmamos la operación. Una vez aplicados desplegados los cambios, los recursos creados se mostrarán en el panel de control de OpenStack-DI, mostrando la instancia modificada y el volumen creado y conectado a la instancia. La figura siguiente ilustra el volumen creado y conectado a la instancia.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/terraform-openstack-volume.png" alt="Terraform OpenStack volume">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ejecutar_un_script_de_inicialización">3.5. Ejecutar un script de inicialización</h3>
<div class="paragraph">
<p>Una característica muy interesante en el despliegue de una instancia es la posibilidad de ejecutar un script de inicialización durante su creación. Esto permite la creación de instancias con paquetes instalados y configurados.</p>
</div>
<div class="paragraph">
<p>Terraform permite esta operación en OpenStack pasando un script en el parámetro <code>user_data</code> al crear la instancia.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Si se modifica el valor de <code>user_data</code> se creará un nuevo servidor si se usa <code>terraform apply</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación se muestra un script <code>install_mysql.sh</code> que configura una base de datos MySQL inicializada con una base de datos de ejemplo. El script realiza las siguientes operaciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Actualizar el repositorio de paquetes.</p>
</li>
<li>
<p>Instalar un servidor MySQL con el password <code>my_password</code>.</p>
</li>
<li>
<p>Descargar un archivo con un script SQL para inicializar una base de datos de ejemplo.</p>
</li>
<li>
<p>Ejecutar el archivo SQL para inicializar la base de datos. La inicialización consiste en la creación de una base de datos denominada <code>SG (Sporting Goods)</code>, la creación de una tabla denominada <code>s_customers</code>, la inserción de datos en la tabla y la creación de un usuario <code>SG</code> con permisos sobre la base de datos.</p>
</li>
<li>
<p>Modificar el archivo de configuración de MySQL (<code>mysqld.cnf</code>) para que admita conexiones desde cualquier lugar.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">El script <code>install_mysql.sh</code></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash

sudo debconf-set-selections &lt;&lt;&lt; 'mysql-server mysql-server/root_password password my_password'
sudo debconf-set-selections &lt;&lt;&lt; 'mysql-server mysql-server/root_password_again password my_password'
sudo apt update
sudo apt -y install mysql-server
wget https://gist.githubusercontent.com/ualmtorres/f8d0e5ea79a0e570f495087724288c6d/raw/0a894b23466bb6eea520a05559372e148e6e5803/sginit.sql -O /home/ubuntu/sginit.sql
mysql -h "localhost" -u "root" "-pmy_password" &lt; "/home/ubuntu/sginit.sql"

sudo sed -i 's/127.0.0.1/0.0.0.0/g' /etc/mysql/mysql.conf.d/mysqld.cnf
sudo service mysql restart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para crear la instancia con Terraform basta con crear el recurso pasando a la propiedad <code>user_data</code> el nombre y la ruta del script de inicialización. En este caso, se supone que el script de inicialización está en el mismo directorio que el script Terraform.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">#Crear nodo mysql
resource "openstack_compute_instance_v2" "mysql" {
  name              = "mysql"
  image_name        = "jammy"
  availability_zone = "nova"
  flavor_name       = "medium"
  key_pair          = var.openstack_keypair
  security_groups   = ["default"]
  network {
    name = var.openstack_network_name
  }
  user_data = file("install_mysql.sh") <b class="conum">(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Pasar el script de inicialización de la instancia</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Tras ejecutar <code>terraform apply</code>, Terraform creará la instancia con el script de inicialización. El script se ejecutará durante la creación de la instancia. La instancia creada tendrá un servidor MySQL instalado y configurado con la base de datos <code>SG</code> inicializada.</p>
</div>
</div>
<div class="sect2">
<h3 id="_archivos_de_plantilla">3.6. Archivos de plantilla</h3>
<div class="paragraph">
<p>Una característica muy interesante de Terraform es la posibilidad de definir scripts con contenido dinámico. Se trata de archivos que interpolan el valor de variables generadas durante el proceso de despliegue.</p>
</div>
<div class="paragraph">
<p>El procedimiento es el siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generar variables de salida</p>
</li>
<li>
<p>Crear archivos de plantilla con extensión <code>.tpl</code> que obtengan los valores de dichas variables con la sintaxis siguiente <code>${nombre-variable}</code>.</p>
</li>
<li>
<p>Interpolar mediante la función <code>templatefile</code> donde sea necesario los archivos plantilla con la sintaxis siguiente <code>data.template_file.objeto-template-file.rendered</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para ilustrar su uso:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Interpolaremos las variables en el archivo de plantilla</p>
</li>
<li>
<p>Crearemos una plantilla que obtenga la dirección IP de un servidor MySQL creado en el despliegue (almacenada en una variable <code>output</code>). Dicha variable se usará para definir una variable de entorno en la instancia definida y para cambiar las variables de entorno de Apache.</p>
</li>
<li>
<p>Crearemos una instancia inicializada con el archivo de la plantilla. La instancia será un servidor web inicializado con una aplicación PHP sencilla. La aplicación usará la variable de entorno inicializada por el script. La variable de entorno contiene la dirección IP del servidor MySQL al que accede la aplicación para mostrar sus datos.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Proceso de interpolación de las variables en el archivo <code>main.tf</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">data "template_file" "install_appserver" {
  template = file("install_appserver.tpl") <b class="conum">(1)</b>
  vars = {
    mysql_ip = openstack_compute_instance_v2.mysql.network.0.fixed_ip_v4 <b class="conum">(2)</b>
  }
  depends_on = [openstack_compute_instance_v2.mysql] <b class="conum">(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Archivo de plantilla</p>
</li>
<li>
<p>Inicialización de la variable</p>
</li>
<li>
<p>Esperar a que esté creada la instancia para obtener su IP.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Archivo plantilla <code>install_appserver.tpl</code></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash
echo "export MYSQL_SERVER=${mysql_ip}" &gt;&gt; /home/ubuntu/.profile <b class="conum">(1)</b>

sudo apt-get update
sudo apt-get install -y apache2 php php-mysql libapache2-mod-php php-mcrypt
sudo chgrp -R www-data /var/www
sudo chmod -R 775 /var/www
sudo chmod -R g+s /var/www
sudo useradd -G www-data ubuntu
sudo chown -R ubuntu /var/www/

sudo rm /var/www/html/index.html
wget https://gist.githubusercontent.com/ualmtorres/1c833f9b471fa7351e2725731596f45e/raw/a66b26d90b5f75c3a37cfe12a2370b57d2768132/sginit.php -O /var/www/html/index.php

echo "export MYSQL_SERVER=${mysql_ip}" &gt;&gt; /etc/apache2/envvars <b class="conum">(2)</b>
sudo service apache2 restart</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Inicialización de una variable de entorno con el valor de la variable <code>mysql_ip</code>.</p>
</li>
<li>
<p>Inicialización de una variable de entorno Apache con el valor de la variable <code>mysql_ip</code>.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Creación del recurso con el script de inicialización interpolado</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#Crear nodo appserver
resource "openstack_compute_instance_v2" "appserver" {
  name              = "appserver"
  image_name        = "Ubuntu 16.04 LTS"
  availability_zone = "nova"
  flavor_name       = "medium"
  key_pair          = "mtorres_ual"
  security_groups   = ["default"]
  network {
    name = "desarrollo-net"
  }

  user_data = data.template_file.install_appserver.rendered <b class="conum">(1)</b>

  depends_on = [openstack_compute_instance_v2.mysql]

}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Interpolación del archivo plantilla</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_ejemplo_completo">3.7. Ejemplo completo</h3>
<div class="paragraph">
<p>En este apartado crearemos un escenario más complejo que combine creación de recursos de red e instancias aprovisionadas durante su creación.</p>
</div>
<div class="paragraph">
<p>Se trata de crear lo siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Red denominada <code>desarrollo-net</code>. Contendrá una subred denominada <code>desarrollo-subnet</code> con direcciones <code>10.2.0.0./24</code> y estos servidores DNS: <code>150.214.156.2 8.8.8.8</code>.</p>
</li>
<li>
<p>Router denominado <code>desarrollo-router</code> que conecte la red exterior <code>ext-net</code> con la red <code>desarrollo-net</code> creada anteriormente.</p>
</li>
<li>
<p>Un servidor MySQL inicializado con el script <code>install_mysql.sh</code></p>
</li>
<li>
<p>Un servidor Web con PHP inicializado con el script <code>install_appserver.tpl</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra el diagrama de la infraestructura.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/EjemploCompleto.png" alt="EjemploCompleto">
</div>
</div>
<div class="paragraph">
<p>Tras finalizar el despliegue tendremos la configuración de red realizada, un servidor MySQL con una base de datos inicializada y servidor web con aplicación PHP de catálogo de productos desplegada. Terraform nos informará con las variables de salida.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Apply complete! Resources: 10 added, 0 changed, 0 destroyed.

Outputs:

Appserver_Floating_IP = 192.168.68.112
MySQL_Floating_IP = 192.168.68.135</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si accedemos a la dirección IP del servidor web veremos la aplicación de catálogo mostrando los productos almacenados en la base de datos.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/SGApp.png" alt="SGApp">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_despliegue_en_google_cloud">4. Despliegue en Google Cloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>El provider <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs">Google Cloud</a> permite crear configuraciones Terraform para desplegar configuraciones en el gran conjunto de servicios de Google Cloud. Entre los recursos que podemos gestionar están:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Infraestructura (Instancias, Imágenes, Redes, &#8230;&#8203;)</p>
</li>
<li>
<p>App Engine</p>
</li>
<li>
<p>Bases de datos (Cloud SQL, Big Query, Firebase, &#8230;&#8203;)</p>
</li>
<li>
<p>Kubernetes</p>
</li>
<li>
<p>Cloud Storage</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_crear_una_clave_para_la_cuenta_de_servicio">4.1. Crear una clave para la Cuenta de servicio</h3>
<div class="ulist">
<ul>
<li>
<p>Seleccionar el proyecto Google Cloud.</p>
</li>
<li>
<p>En el menú de navegación seleccionar <code>IAM y administración | Cuentas de servicio</code>.</p>
</li>
<li>
<p>Seleccionar <code>Crear cuenta de servicio</code>.</p>
</li>
<li>
<p>Darle un nombre (p.e. <code>terraform</code>)</p>
</li>
<li>
<p>Seleccionar <code>Crear y continuar</code>.</p>
</li>
<li>
<p>En el paso <code>Otorga a esta cuenta de servicio acceso al proyecto</code> del asistente, seleccionar el rol <code>Proyecto &#8594; Editor</code>.</p>
</li>
<li>
<p>Pulsar el botón <code>Listo</code>. No es necesario configurar nada más en este asistente.</p>
</li>
<li>
<p>Editar la Cuenta de servicio. En la sección <code>Claves</code> seleccionar <code>Agregar clave | Crear clave nueva</code>.</p>
</li>
<li>
<p>Dejar <code>JSON</code> en el tipo de clave..</p>
</li>
<li>
<p>Seleccionar <code>Crear</code>. A continuación se descargará a nuestro equipo la clave privada.</p>
</li>
<li>
<p>En el menú de navegación seleccionar <code>IAM y adminsitración | IAM</code>, en la pestaña de <code>Permisos</code> localizar la cuenta de servicio creada para <code>terraform</code> y pulsar sobre <code>Editar cuenta principal</code>.</p>
</li>
<li>
<p>Pulsar sobre <code>Agregar otra función</code>. Seleccionar <code>Service Networking - Administrador de Service Networking</code>.</p>
</li>
<li>
<p>Guardar los cambios.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_del_provider_2">4.2. Configuración del provider</h3>
<div class="paragraph">
<p>Para usarlo hay que configurar sus <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs">parámetros de acceso</a>. Lo haremos en un archivo <code>providers.tf</code></p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>providers.tf</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">terraform {
  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "6.5.0"
    }
  }
}

provider "google" {
  credentials = file("../gcp-identity.json") <b class="conum">(1)</b>

  project = var.gcp-project
  region  = "us-central1"
  zone    = "us-central1-c"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ruta al archivo de credenciales de la cuenta de servicio descargadas en el paso anterior.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Se usan las variables definidas en el archivo <code>variables.tf</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">variable "gcp-username" {
  description = "GCP user name"
  default     = "mtorres"
}

variable "gcp-project" {
  description = "GCP project"
  default     = "cc2025-mtorres"
}

variable "gcp-network" {
  description = "GCP network"
  default     = "terraform-network"
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inicializar_el_provider_2">4.3. Inicializar el provider</h3>
<div class="paragraph">
<p>Para inicializar ejecutar <code>terraform init</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Initializing the backend...

Initializing provider plugins...
- Finding hashicorp/google versions matching "6.5.0"...
- Installing hashicorp/google v6.5.0...
- Installed hashicorp/google v6.5.0 (signed by HashiCorp)

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run "terraform init" in the future.

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto creará una carpeta <code>.terraform</code> con en plugin de Google Cloud instalado y disponible para ser usado en el proyecto. También crea un archivo <code>.terraform.lock.hcl</code> que registra las selecciones de proveedores realizadas. Este archivo se debe incluir en el repositorio de control de versiones para garantizar que Terraform haga las mismas selecciones por defecto cuando se ejecute <code>terraform init</code> en el futuro.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_de_la_red">4.4. Configuración de la red</h3>
<div class="paragraph">
<p>Para crear una red en Google Cloud usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_network">google_compute_network</a>. En el siguiente ejemplo se crea una red denominada <code>terraform-network</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">resource "google_compute_network" "vpc_network" {
  name = var.gcp-network
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>También crearemos las reglas de firewall para permitir el tráfico de entrada y salida en la red. Para ello usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_firewall">google_compute_firewall</a>. En este ejemplo veremos cómo añadir una regla ICMP que permita el tráfico PING desde cualquier origen, una regla SSH que permita el tráfico SSH desde cualquier origen y una regla que permite todo el tráfico interno. El tráfico interno lo entenderemos dentro de la región <code>us-central1</code> con máscara de red <code>10.128.0.0/20</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">resource "google_compute_network" "vpc_network" {
  name = var.gcp-network
}

resource "google_compute_firewall" "firewall-icmp" {
  name    = "terraform-allow-icmp"
  network = google_compute_network.vpc_network.name

  allow {
    protocol = "icmp"
  }

  source_ranges = ["0.0.0.0/0"]
}

resource "google_compute_firewall" "firewall-ssh" {
  name    = "terraform-allow-ssh"
  network = google_compute_network.vpc_network.name

  allow {
    protocol = "tcp"
    ports    = ["22"]
  }

  source_ranges = ["0.0.0.0/0"]
}

resource "google_compute_firewall" "firewall-internal" {
  name    = "terraform-allow-internal"
  network = google_compute_network.vpc_network.name

  allow {
    protocol = "tcp"
    ports    = ["0-65535"]
  }

  allow {
    protocol = "udp"
    ports    = ["0-65535"]
  }

  allow {
    protocol = "icmp"
  }

  source_ranges = ["10.128.0.0/20"]
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_despliegue_de_una_instancia_2">4.5. Despliegue de una instancia</h3>
<div class="paragraph">
<p>La creación de una instancia se realiza con <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_instance">google_compute_instance</a>.</p>
</div>
<div class="paragraph">
<p>A continuación, crearemos una instancia denominada <code>tf-vm</code>. El nombre que se use en <code>resource</code>, no el nombre asignado en <code>name</code>, es el que referencia al objeto resource creado. Esto permite tratar el recurso creado (p.e. para asignarle una dirección IP externa, para conectarle un volumen, …​).</p>
</div>
<div class="paragraph">
<p>En el ejemplo siguiente se ilustra la creación de una máquina virtual con una dirección IP efímera.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>De forma predeterminada, si no se indica ninguna dirección IP fija, Google Cloud creará una efímera para la máquina virtual.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">resource "google_compute_instance" "tf-vm" { <b class="conum">(1)</b>
  name         = "tf-vm"
  zone         = "us-central1-c"
  machine_type = "n1-standard-1"
  boot_disk {
    initialize_params {
      image = "debian-cloud/debian-11"
    }
  }

  # Add SSH access to the Compute Engine instance
  metadata = {
    ssh-keys = "${var.gcp-username}:${file("~/.ssh/id_rsa.pub")}"
  }

  # Startup script
  # metadata_startup_script = "${file("update-docker.sh")}"

  network_interface { <b class="conum">(2)</b>
    network    = var.gcp-network
    subnetwork = var.gcp-network

    access_config {} <b class="conum">(3)</b>
  }
}

output "tf-vm-internal-ip" { <b class="conum">(4)</b>
  value      = google_compute_instance.tf-vm.network_interface.0.network_ip
  depends_on = [google_compute_instance.tf-vm]
}

output "tf-vm-ephemeral-ip" { <b class="conum">(5)</b>
  value      = google_compute_instance.tf-vm.network_interface.0.access_config.0.nat_ip
  depends_on = [google_compute_instance.tf-vm]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Creación de un recurso instancia (máquina virtual) en Google Cloud. El objeto recurso creado es asignado a la variable <code>tf-vm</code>.</p>
</li>
<li>
<p>Red a la que se conectará la instancia creada.</p>
</li>
<li>
<p>Dejar <code>access_config</code> sin configurar hará que se genere una dirección IP efímera.</p>
</li>
<li>
<p>Dirección IP interna de la instancia</p>
</li>
<li>
<p>Dirección IP efímera de la instancia</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_modificar_el_despliegue_2">4.6. Modificar el despliegue</h3>
<div class="paragraph">
<p>A modo de ilustración este ejemplo muestra cómo aplicar cambios a una configuración desplegada previamente. En este caso se trata de:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cambiar el tipo de máquina de la instancia desplegada a <code>n1-standard-2</code>.</p>
</li>
<li>
<p>Crear un volumen de 1GB (<a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_disk"><code>google_compute_disk</code></a>).</p>
</li>
<li>
<p>Conectar el volumen a la máquina virtual (<a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_attached_disk"><code>google_compute_attached_disk</code></a>).</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">resource "google_compute_instance" "tf-vm" {
  name         = "tf-vm"
  zone         = "us-central1-c"
  machine_type = "n1-standard-2" <b class="conum">(1)</b>
  boot_disk {
    initialize_params {
      image = "debian-cloud/debian-11"
    }
  }
...
resource "google_compute_disk" "tf-disk" { <b class="conum">(2)</b>
  name = "tf-disk"
  type = "pd-ssd" <b class="conum">(3)</b>
  size = 1 <b class="conum">(4)</b>
}

resource "google_compute_attached_disk" "attached-tf-disk" {<b class="conum">(5)</b>
  disk     = google_compute_disk.tf-disk.id <b class="conum">(6)</b>
  instance = google_compute_instance.tf-vm.id <b class="conum">(7)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Modificación del tamaño de la imagen</p>
</li>
<li>
<p>Creación de un recurso volumen</p>
</li>
<li>
<p>Tipo SSD</p>
</li>
<li>
<p>Especificación del tamaño del volumen</p>
</li>
<li>
<p>Conexión del volumen a la instancia</p>
</li>
<li>
<p>Acceso al id del volumen creado</p>
</li>
<li>
<p>Acceso al id de la instancia</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Al ejecutar con <code>terraform apply</code>, Terraform nos informará de los cambios detectados y de la nueva configuración. La nueva configuración se aplicará si confirmamos la operación. Una vez aplicados desplegados los cambios, los recursos creados se mostrarán en el panel de control de Google Cloud, mostrando la instancia modificada y el volumen creado y conectado a la instancia. Si nos conectamos a la instancia con <code>ssh</code> podremos ver el volumen creado con <code>lsblk</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ lsblk
NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda       8:0    0   10G  0 disk <b class="conum">(1)</b>
├─sda1    8:1    0  9.9G  0 part /
├─sda14   8:14   0    3M  0 part
└─sda15   8:15   0  124M  0 part /boot/efi
sdb       8:16   0    1G  0 disk <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Disco de la instancia</p>
</li>
<li>
<p>Volúmen creado y conectado a la instancia</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_creación_de_una_instancia_con_una_dirección_ip_estática">4.7. Creación de una instancia con una dirección IP estática</h3>
<div class="paragraph">
<p>De forma predeterminada, Google Cloud crea una dirección IP efímera para las instancias. Si queremos una dirección IP estática, debemos crearla y asignarla a la instancia. Para ello, usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_address"><code>google_compute_address</code></a>. En el siguiente ejemplo se crea una dirección IP estática denominada <code>tf-vm-ip</code>. A la hora de crear la instancia, una forma de asignar la dirección IP estática creada es a través de la configuración <code>access_config</code> de la tarjeta de red de la instancia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">resource "google_compute_address" "tf-vm-ip" { <b class="conum">(1)</b>
  name = "ipv4-address-tf-vm"
}

resource "google_compute_instance" "tf-vm" { <b class="conum">(2)</b>
  name         = "tf-vm"
  machine_type = "n1-standard-1"
  boot_disk {
    initialize_params {
      image = "debian-cloud/debian-11"
    }
  }

...

  network_interface {
    network    = var.gcp-network
    subnetwork = var.gcp-network

    access_config {
      nat_ip = google_compute_address.tf-vm-ip.address <b class="conum">(3)</b>
    }
  }
}

output "tf-vm-ip" { <b class="conum">(4)</b>
  value      = google_compute_address.tf-vm-ip.address
  depends_on = [google_compute_instance.tf-vm]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Creación de un recurso dirección IP estática</p>
</li>
<li>
<p>Creación de un recurso instancia (máquina virtual) en Google Cloud</p>
</li>
<li>
<p>Asignación de la dirección IP estática a la instancia</p>
</li>
<li>
<p>Dirección IP estática de la instancia</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_ejecutar_un_script_de_inicialización_2">4.8. Ejecutar un script de inicialización</h3>
<div class="paragraph">
<p>Una característica muy interesante en el despliegue de una instancia es la posibilidad de ejecutar un script de inicialización durante su creación. Esto permite la creación de instancias con paquetes instalados y configurados.</p>
</div>
<div class="paragraph">
<p>Terraform permite esta operación en GCP pasando un script en el parámetro <code>metadata_startup_script</code> al crear la instancia.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Si se modifica el valor de <code>metadata_startup_script</code> se creará un nuevo servidor si se usa <code>terraform apply</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>En este apartado veremos cómo crear una instancia Ubuntu aprovisionada con Docker. Además, la instancia se inicializará con un archivo <code>docker-compose.yml</code> que despliega dos contenedores: un contenedor MySQL con una base de datos inicializada y otro contenedor con una aplicación PHP que muestra un catálogo de productos almacenados en el contenedor MySQL.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>El script de instalación es válido para Ubuntu. Si se usan otras otras distribuciones Linux será necesario adaptar el script de instalación a las peculiaridades de la distribución utilizada.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La aplicación deberá ser accesible en Internet. Por tanto, hay que definir una regla en el cortafuegos que permita la comunicación HTTP. La regla tendrá una etiqueta asociada. Las instancias que deseen aplicar la regla incluirán la etiqueta correspondiente en su definición.</p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>network-firewall.tf</code></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># allow http traffic
resource "google_compute_firewall" "allow-http" {
  name    = "tf-fw-allow-http" <b class="conum">(1)</b>
  network = var.gcp-network <b class="conum">(2)</b>
  allow {
    protocol = "tcp"
    ports    = ["80"] <b class="conum">(3)</b>
  }
  target_tags   = ["http"] <b class="conum">(4)</b>
  source_ranges = ["0.0.0.0/0"] <b class="conum">(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nombre de la regla del firewall</p>
</li>
<li>
<p>Red a la que se aplica la regla definida</p>
</li>
<li>
<p>Puerto abierto</p>
</li>
<li>
<p>Etiqueta para poder usar la regla</p>
</li>
<li>
<p>Rango de direcciones IP permitidas. En este caso, cualquier dirección IP</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">El archivo <code>main.tf</code></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">resource "google_compute_instance" "tf-vm" {
  name         = "tf-vm"
  zone         = "us-central1-c"
  machine_type = "n1-standard-1"
  boot_disk {
    initialize_params {
      image = "ubuntu-os-cloud/ubuntu-2204-lts" <b class="conum">(1)</b>
    }
  }

  # Add SSH access to the Compute Engine instance
  metadata = {
    ssh-keys = "${var.gcp-username}:${file("~/.ssh/id_rsa.pub")}"
  }

  # Add http tag to the instance to identify it in the firewall rule
  tags = ["http"] <b class="conum">(2)</b>

  # Startup script
  metadata_startup_script = file("setup-docker.sh") <b class="conum">(3)</b>

  network_interface {
    network    = var.gcp-network
    subnetwork = var.gcp-network

    access_config {}
  }
}

output "tf-vm-internal-ip" {
  value      = google_compute_instance.tf-vm.network_interface.0.network_ip
  depends_on = [google_compute_instance.tf-vm]
}

output "tf-vm-ephemeral-ip" {
  value      = google_compute_instance.tf-vm.network_interface.0.access_config.0.nat_ip
  depends_on = [google_compute_instance.tf-vm]
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Imagen de la instancia</p>
</li>
<li>
<p>Etiqueta para identificar la instancia en la regla del cortafuegos</p>
</li>
<li>
<p>Script de inicialización de la instancia</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">El script <code>setup-docker.sh</code> de inicialización de la instancia</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash

echo "Instalando Docker"

# Add Docker's official GPG key:
apt-get update
apt-get install -y ca-certificates curl
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release &amp;&amp; echo "$VERSION_CODENAME") stable" | \
  tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
apt-get update

apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
systemctl enable docker

git clone https://github.com/ualmtorres/docker_customer_catalog.git <b class="conum">(1)</b>
cd docker_customer_catalog
docker compose up -d <b class="conum">(2)</b>

exit 0</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Clonado del repositorio con el archivo de despliegue, la aplicación y el script de inicialización de la base de datos</p>
</li>
<li>
<p>Despliegue del entorno (Base de datos + Aplicación)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Para crear la instancia con Terraform basta con crear el recurso pasando a la propiedad <code>metadata_startup_script</code> el nombre y la ruta del script de inicialización. En este caso, se supone que el script de inicialización está en el mismo directorio que el script Terraform.</p>
</div>
<div class="paragraph">
<p>La figura siguiente ilustra el resultado tras unos minutos que se necesitan para la creación e inicialización de la instancia y despliegue de la base de datos y la aplicación de catálogo.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/CustomerCatalog.png" alt="CustomerCatalog">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Si estamos interesados en mostrar el log de arranque de la instancia para comprobar que el script de inicialización se ha ejecutado correctamente, podemos hacerlo desde la propia instancia ejecutando <code>sudo journalctl -u google-startup-scripts.service</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_despliegue_en_microsoft_azure">5. Despliegue en Microsoft Azure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>El provider <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs">Microsoft Azure</a> permite crear configuraciones Terraform para desplegar configuraciones en el gran conjunto de servicios de Azure. Entre los recursos que podemos gestionar están:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Infraestructura (Instancias, Imágenes, Redes, &#8230;&#8203;)</p>
</li>
<li>
<p>App Service</p>
</li>
<li>
<p>Bases de datos (SQL, CosmosDB, &#8230;&#8203;)</p>
</li>
<li>
<p>Kubernetes</p>
</li>
<li>
<p>Storage</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_autenticación_en_azure">5.1. Autenticación en Azure</h3>
<div class="paragraph">
<p>Para autenticarse en Azure, Terraform necesita que se haya iniciado la sesión con el CLI de Azure y proporcionar las credenciales de la suscripción y del proyecto en Azure. Las credenciales se obtendrán a través del CLI de Azure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Azure CLI es una herramienta de línea de comandos que proporciona una experiencia unificada para administrar los servicios de Azure. Para instalarlo, seguir las instrucciones en <a href="https://learn.microsoft.com/es-es/cli/azure/install-azure-cli">Instalación de la CLI de Azure</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para obtener las credenciales necesarias, seguir los siguientes pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Iniciar sesión en Azure con <code>az login</code>. Esto abrirá un navegador para autenticarse en Azure. Tras la autenticación, se mostrará un mensaje de confirmación en la terminal y devolverá los datos de la cuenta.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Retrieving tenants and subscriptions for the selection...

[Tenant and subscription selection]

No     Subscription name    Subscription ID                       Tenant
-----  -------------------  ------------------------------------  ----------------------
[1] *  Azure for Students   00000000-0000-0000-0000-000000000000  University of XXXXXXX</code></pre>
</div>
</div>
</li>
<li>
<p>Seleccionar la suscripción y el proyecto con la que se desea trabajar. El listado aparecerá numerado. Introdcir el número correspondiente a la suscripción y al proyecto.</p>
</li>
<li>
<p>Obtener los detalles de la suscripción con <code>az account show</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{
  "environmentName": "AzureCloud",
  "homeTenantId": "00000000-0000-0000-0000-000000000000",
  "id": "00000000-0000-0000-0000-000000000000", <b class="conum">(1)</b>
  "isDefault": true,
  "managedByTenants": [],
  "name": "Azure for Students",
  "state": "Enabled",
  "tenantDefaultDomain": "students.uxxxxxx.es",
  "tenantDisplayName": "University of XXXXXXX",
  "tenantId": "00000000-0000-0000-0000-000000000000", <b class="conum">(2)</b>
  "user": {
    "name": "robertsmith@ual.es",
    "type": "user"
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>ID de la suscripción</p>
</li>
<li>
<p>ID del proyecto</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Los datos que necesitamos para configurar el provider de Azure en Terraform son los que hemos destacado en el listado anterior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>subscription_id</code>: ID de la suscripción.</p>
</li>
<li>
<p><code>tenant_id</code>: ID del proyecto.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_del_provider_3">5.2. Configuración del provider</h3>
<div class="paragraph">
<p>Para usarlo hay que configurar sus <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/azure_cli">parámetros de acceso</a>. Lo haremos en un archivo <code>providers.tf</code></p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>providers.tf</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf"># We strongly recommend using the required_providers block to set the
# Azure Provider source and version being used
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "=4.1.0"
    }
  }
}

# Configure the Microsoft Azure Provider
provider "azurerm" {
  features {}

  subscription_id = var.azure-subscription
  tenant_id       = var.azure-tenant

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se usan las variables definidas en el archivo <code>variables.tf</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">variable "azure-subscription" {
  description = "Azure subscription id"
}

variable "azure-tenant" {
  description = "Azure tenant id"
}

variable "azure-resource-group" {
  description = "Azure resource group name"
}

variable "azure-location" {
  description = "Azure location"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Los valores de las variables se pueden definir en un archivo <code>terraform.tfvars</code></p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>terraform.tfvars</code></div>
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">azure-subscription = "00000000-0000-0000-0000-000000000000"
azure-tenant       = "00000000-0000-0000-0000-000000000000"
azure-resource-group = "tf-resource-group"
azure-location = "France Central"</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>El archivo <code>terraform.tfvars</code> no debe ser incluido en el control de versiones. Contiene información sensible.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_inicializar_el_provider_3">5.3. Inicializar el provider</h3>
<div class="paragraph">
<p>Para inicializar ejecutar <code>terraform init</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Initializing the backend...

Initializing provider plugins...
- Finding hashicorp/azurerm versions matching "4.1.0"...
- Installing hashicorp/azurerm v4.1.0...
- Installed hashicorp/azurerm v4.1.0 (signed by HashiCorp)

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run "terraform init" in the future.

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto creará una carpeta <code>.terraform</code> con en plugin de Azure instalado y disponible para ser usado en el proyecto. También crea un archivo <code>.terraform.lock.hcl</code> que registra las selecciones de proveedores realizadas. Este archivo se debe incluir en el repositorio de control de versiones para garantizar que Terraform haga las mismas selecciones por defecto cuando se ejecute <code>terraform init</code> en el futuro.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creación_de_un_grupo_de_recursos">5.4. Creación de un grupo de recursos</h3>
<div class="paragraph">
<p>Un grupo de recursos es un contenedor que mantiene los recursos relacionados para una solución de Azure. Los recursos pueden incluir instancias, bases de datos, redes, etc. Los recursos de un grupo de recursos pueden ser administrados, eliminados o actualizados en conjunto. Para crear un grupo de recursos usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group"><code>azurerm_resource_group</code></a>.</p>
</div>
<div class="paragraph">
<p>En el siguiente ejemplo se crea un grupo de recursos denominado <code>tf-resource-group</code> en la región <code>France Central</code>, que es la región que hemos definido en el archivo <code>terraform.tfvars</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">resource "azurerm_resource_group" "tf-resource-group" {
  name     = var.azure-resource-group
  location = var.azure-location
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Desplegando con <code>terraform apply</code> se creará el grupo de recursos en Azure.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuración_de_la_red_2">5.5. Configuración de la red</h3>
<div class="paragraph">
<p>La configuración de una red en Azure pasa por la creación de una red virtual y una subred. Es posible crear la subred directamente en la creación de la red virtual. Sin embargo, es recomendable crear la red y la subred por separado para tener un mayor control sobre la configuración de la red. Posteriormente, necesitaremos crear una interfaz de red para conectar la instancia a la red. Esta interfaz de red deberá estar conectada a la subred. Por tanto, necesitamos que la subred sea un recurso independiente para poder usarlo en la creación de la interfaz de red. Así que, resumiendo, crearemos la red y la subred por separado.</p>
</div>
<div class="paragraph">
<p>Para crear una red en Azure usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_network"><code>azurerm_virtual_network</code></a>. Para crear una subred usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet"><code>azurerm_subnet</code></a>. En el siguiente ejemplo se crea una red denominada <code>tf-net</code> y una subred denominada <code>tf-subnet</code>, ambas en la región <code>France Central</code> con el rangos de direcciones <code>10.0.0.0/24</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">resource "azurerm_virtual_network" "tf-net" {
  name                = var.azure-net-name
  location            = azurerm_resource_group.tf-resource-group.location
  resource_group_name = azurerm_resource_group.tf-resource-group.name
  address_space       = var.azure-address-space
  dns_servers         = var.azure-dns-servers
}

resource "azurerm_subnet" "tf-subnet" {
  name                 = var.azure-subnet-name
  resource_group_name  = azurerm_resource_group.tf-resource-group.name
  virtual_network_name = azurerm_virtual_network.tf-net.name
  address_prefixes     = var.azure-subnet-prefixes
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>El archivo <code>variables.tf</code> tendrá que ser modificado para incluir las variables necesarias para la creación de la red.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">...
# Nuevo contenido

variable "azure-net-name" {
  description = "Azure virtual net name"
}

variable "azure-address-space" {
  description = "Azure address space"
  type        = list(string)
}

variable "azure-dns-servers" {
  description = "Azure DNS servers"
  type        = list(string)
}

variable "azure-subnet-name" {
  description = "Azure subnet name"
}

variable "azure-subnet-prefixes" {
  description = "Azure subnet prefixes"
  type        = list(string)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>El archivo <code>terraform.tfvars</code> tendrá que ser modificado para incluir los valores de las variables necesarias para la creación de la red.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">...
# Nuevo contenido

azure-address-space        = ["10.0.0.0/24"]
azure-dns-servers          = ["8.8.8.8"]
azure-subnet-name          = "tf-subnet"
azure-subnet-prefixes      = ["10.0.0.0/24"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Desplegando con <code>terraform apply</code> se crearán en Azure la red y la subred.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creación_de_una_instancia">5.6. Creación de una instancia</h3>
<div class="paragraph">
<p>En esta sección vamos a crear una instancia en Azure configurada en el arranque con un servidor web Apache. Además, crearemos un disco de datos que se conectará a la instancia. La instancia se creará en la red creada anteriormente. En Azure, la conexión de una instancia a la red se realizar a través de un recurso denominado interfaz de red. Por tanto, necesitaremos crear una interfaz de red para conectar la instancia a la red. En cuanto al acceso a la instancia, se permitirá el acceso a través del puerto 22 para SSH y del puerto 80 para HTTP. Esto exige crear un grupo de seguridad de red que permita el tráfico a través de estos puertos. Además, habrá que crear una dirección IP pública y asignarla a la instancia. A continuación se muestran los pasos a seguir para crear la instancia;</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear un grupo de seguridad de red que permita el tráfico a través de los puertos 22 y 80.</p>
</li>
<li>
<p>Crear una dirección IP pública.</p>
</li>
<li>
<p>Crear una interfaz de red conectada a la red y configurada con la dirección IP pública.</p>
</li>
<li>
<p>Aplicar el grupo de seguridad de red a la interfaz de red.</p>
</li>
<li>
<p>Crear la instancia conectada a la interfaz de red. La instancia se inicializará con un script de arranque que instalará y configurará el servidor web Apache.</p>
</li>
<li>
<p>Crear un disco de datos y conectarlo a la instancia.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_creación_de_un_grupo_de_seguridad_de_red">5.6.1. Creación de un grupo de seguridad de red</h4>
<div class="paragraph">
<p>Un grupo de seguridad de red es un conjunto de reglas que permiten o deniegan el tráfico de red a las instancias conectadas a la red. Para crear un grupo de seguridad de red usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group"><code>azurerm_network_security_group</code></a>. En el siguiente ejemplo se crea un grupo de seguridad de red denominado <code>tf-nsg</code> que permite el tráfico a través de los puertos 22 y 80.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">...
# Nuevo contenido

resource "azurerm_network_security_group" "tf-nsg" {
  name                = "tf-nsg"
  location            = azurerm_resource_group.tf-resource-group.location
  resource_group_name = azurerm_resource_group.tf-resource-group.name

  security_rule {
    name                       = "SSH"
    priority                   = 1001
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_port_range          = "*"
    destination_port_range     = "22"
    source_address_prefix      = "*"
    destination_address_prefix = "*"
  }

  security_rule {
    name                       = "HTTP"
    priority                   = 1002
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_port_range          = "*"
    destination_port_range     = "80"
    source_address_prefix      = "*"
    destination_address_prefix = "*"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Desplegando con <code>terraform apply</code> se creará en Azure el grupo de seguridad de red.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_una_dirección_ip_pública">5.6.2. Creación de una dirección IP pública</h4>
<div class="paragraph">
<p>En Azure, una dirección IP pública puede ser estática o dinámica. Esta funcionalidad se configura a través de la propiedad <code>sku</code>. El sku básico es gratuito. La diferencia entre ambos es que el sku básico no permite la asignación de una dirección IP estática.</p>
</div>
<div class="paragraph">
<p>Para crear una dirección IP pública usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/public_ip"><code>azurerm_public_ip</code></a>. En el siguiente ejemplo se crea una dirección IP pública denominada <code>tf-ip</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">...
# Nuevo contenido

resource "azurerm_public_ip" "tf-web-server-ip" {
  name                = "tf-web-server-ip"
  location            = azurerm_resource_group.tf-resource-group.location
  resource_group_name = azurerm_resource_group.tf-resource-group.name
  allocation_method   = "Dynamic"
  sku                 = "Basic"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Desplegando con <code>terraform apply</code> se creará en Azure la dirección IP pública.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_una_interfaz_de_red">5.6.3. Creación de una interfaz de red</h4>
<div class="paragraph">
<p>Para crear una interfaz de red usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface"><code>azurerm_network_interface</code></a>. En el siguiente ejemplo se crea una interfaz de red denominada <code>tf-nic</code> conectada a la red y configurada con la dirección IP pública. También se aplica el grupo de seguridad de red creado anteriormente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">...
# Nuevo contenido

resource "azurerm_network_interface" "tf-nic" {
  name                = "tf-nic"
  location            = azurerm_resource_group.tf-resource-group.location
  resource_group_name = azurerm_resource_group.tf-resource-group.name

  ip_configuration {
    name                          = "internal"
    subnet_id                     = azurerm_subnet.tf-subnet.id
    private_ip_address_allocation = "Dynamic" <b class="conum">(1)</b>
    public_ip_address_id          = azurerm_public_ip.tf-web-server-ip.id <b class="conum">(2)</b>
  }
}

resource "azurerm_network_interface_security_group_association" "tf-nic-nsg" { <b class="conum">(3)</b>
  network_interface_id      = azurerm_network_interface.tf-nic.id
  network_security_group_id = azurerm_network_security_group.tf-nsg.id
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Asignación de una dirección IP dinámica</p>
</li>
<li>
<p>Asignación de la dirección IP pública a la interfaz de red</p>
</li>
<li>
<p>Asociación del grupo de seguridad de red a la interfaz de red</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Desplegando con <code>terraform apply</code> se creará en Azure la interfaz de red.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_la_instancia">5.6.4. Creación de la instancia</h4>
<div class="paragraph">
<p>Para crear una instancia usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/linux_virtual_machine"><code>azurerm_linux_virtual_machine</code></a>. En el siguiente ejemplo se crea una instancia denominada <code>tf-vm</code> conectada a la interfaz de red creada anteriormente. La instancia se inicializará con un script de arranque que instalará y configurará el servidor web Apache. Además, será necesario configurar el nombre de usuario, la clave pública de acceso por SSH y los datos de la imagen de la instancia, que en Azure es un poco diferente a la de otros proveedores.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">...
# Nuevo contenido

resource "azurerm_linux_virtual_machine" "tf-web-server" {
  name                = "tf-web-server"
  resource_group_name = azurerm_resource_group.tf-resource-group.name
  location            = azurerm_resource_group.tf-resource-group.location
  size                = var.azure-vm-size
  admin_username      = var.azure-admin-username <b class="conum">(1)</b>
  network_interface_ids = [ <b class="conum">(2)</b>
    azurerm_network_interface.tf-nic.id,
  ]


  admin_ssh_key {
    username   = var.azure-admin-username <b class="conum">(3)</b>
    public_key = file("~/.ssh/id_rsa.pub") <b class="conum">(4)</b>
  }

  os_disk {
    caching              = "ReadWrite"
    storage_account_type = var.azure-storage-account-type
  }

  source_image_reference {
    publisher = var.azure-os-publisher <b class="conum">(5)</b>
    offer     = var.azure-os-offer <b class="conum">(6)</b>
    sku       = var.azure-os-sku <b class="conum">(7)</b>
    version   = var.azure-os-version <b class="conum">(8)</b>
  }

  user_data = base64encode(file("install-web-server.sh")) <b class="conum">(9)</b>

  tags = {
    web_server = "tf-web-server"
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Nombre de usuario administrador de la instancia</p>
</li>
<li>
<p>ID de la interfaz de red a la que se conectará la instancia</p>
</li>
<li>
<p>Nombre de usuario para la clave pública de acceso por SSH</p>
</li>
<li>
<p>Clave pública de acceso por SSH</p>
</li>
<li>
<p>Publicador de la imagen de la instancia</p>
</li>
<li>
<p>Nombre de la imagen de la instancia</p>
</li>
<li>
<p>SKU de la imagen de la instancia. En Azure, el SKU de la imagen es el sistema operativo</p>
</li>
<li>
<p>Versión de la imagen del sistema operativo</p>
</li>
<li>
<p>Script de arranque de la instancia. El script hay que codificarlo en base64</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>La imagen de la instancia en Azure se define por el publicador, la oferta, el SKU y la versión. En el caso de la imagen de Ubuntu que usamos en el ejemplo, los valores son: <code>publisher = "Canonical"</code>, <code>offer = "ubuntu-24-04-lts"</code>, <code>sku = "server"</code>, <code>version = "latest"</code>. No obstante, este convenio puede variar en función de la imagen y de la versión que se desee usar. Este enlace muestra en forma de URN los <a href="https://documentation.ubuntu.com/azure/en/latest/azure-how-to/instances/find-ubuntu-images/">valores de configuración de imágenes Ubuntu para Azure</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>El archivo <code>variables.tf</code> tendrá que ser modificado para incluir las variables necesarias para la creación de la instancia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">...
# Nuevo contenido

variable "azure-vm-size" {
  description = "Azure VM size"
}

variable "azure-admin-username" {
  description = "Admin username"
}

variable "azure-storage-account-type" {
  description = "Storage account type"
  default     = "Standard_LRS"
}

variable "azure-os-publisher" {
  description = "Publisher of the image"
  default     = "Canonical"
}

variable "azure-os-offer" {
  description = "Offer of the image"
  default     = "0001-com-ubuntu-server-noble"
}

variable "azure-os-sku" {
  description = "SKU of the image"
  default     = "24_04-lts"
}

variable "azure-os-version" {
  description = "Version of the image"
  default     = "latest"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>El archivo <code>terraform.tfvars</code> tendrá que ser modificado para incluir los valores de las variables necesarias para la creación de la instancia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">...
# Nuevo contenido

azure-vm-size              = "Standard_B1s"
azure-admin-username       = "mtorres"
azure-storage-account-type = "Standard_LRS"
azure-os-publisher         = "Canonical"
azure-os-offer             = "ubuntu-24_04-lts"
azure-os-sku               = "server"
azure-os-version           = "latest"</code></pre>
</div>
</div>
<div class="paragraph">
<p>El script de arranque de la instancia <code>install-web-server.sh</code> instalará y configurará el servidor web Apache. A continuación se muestra el contenido del script.</p>
</div>
<div class="listingblock">
<div class="title">El script <code>install-web-server.sh</code></div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">#!/bin/bash

apt-get update
apt-get install -y apache2
systemctl enable apache2
systemctl start apache2

echo "&lt;h1&gt;Welcome to Terraform Azure&lt;/h1&gt;" &gt; /var/www/html/index.html</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Se puede añadir un <code>output</code> para mostrar la dirección IP pública de la instancia. Para ello, añadir el siguiente código</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">output "tf-web-server-ip" {
  value      = azurerm_public_ip.tf-web-server-ip.ip_address
  depends_on = [azurerm_linux_virtual_machine.tf-web-server]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Desplegando con <code>terraform apply</code> se creará en Azure la instancia y tras unos minutos se podrá acceder a través de un navegador a la dirección IP pública asignada a la instancia mostrando el mensaje de bienvenida que hemos configurado en el script de arranque. La imagen siguiente muestra el resultado.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/azure-web-server.png" alt="azure web server">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_un_disco_de_datos">5.6.5. Creación de un disco de datos</h4>
<div class="paragraph">
<p>Azure ofrece gran flexibilidad en la creación de discos de datos. Se pueden crear discos de datos independientes o discos de datos que se conectan a la instancia. En este caso, crearemos un disco de datos gestionados que se conectará a la instancia. Para ello, usaremos el recurso <a href="https://registry.terraform.io/providers/hashicorp/Azurerm/3.92.0/docs/resources/managed_disk"><code>azurerm_managed_disk</code></a>. En el siguiente ejemplo se crea un disco de datos denominado <code>tf-web-server-disk</code> de 1GB de tamaño y posteriormente lo conectaremos a la instancia.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-tf" data-lang="tf">...
# Nuevo contenido

resource "azurerm_managed_disk" "tf-web-server-disk" {
  name                 = "tf-web-server-disk"
  location             = azurerm_resource_group.tf-resource-group.location
  resource_group_name  = azurerm_resource_group.tf-resource-group.name
  storage_account_type = var.azure-storage-account-type
  create_option        = "Empty"
  disk_size_gb         = 1 <b class="conum">(1)</b>
}

resource "azurerm_virtual_machine_data_disk_attachment" "tf-web-server-disk" {
  managed_disk_id    = azurerm_managed_disk.tf-web-server-disk.id
  virtual_machine_id = azurerm_linux_virtual_machine.tf-web-server.id
  lun                = 10 <b class="conum">(2)</b>
  caching            = "ReadWrite"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Tamaño del disco en GB</p>
</li>
<li>
<p>Número de unidad lógica (LUN) del disco. Este número debe ser único para cada disco conectado a la instancia. Por defecto, el valor es 0.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Desplegando con <code>terraform apply</code> se creará en Azure el disco de datos y se conectará a la instancia. Si nos conectamos a la instancia con <code>ssh</code> podremos ver el disco creado con <code>lsblk</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_recursos_de_interés">5.7. Recursos de interés</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.hashicorp.com/collections/terraform/gcp-get-started">Tutorial Get Started - Google Cloud con Terraform</a></p>
</li>
<li>
<p><a href="https://medium.com/google-cloud/deploying-docker-images-to-cloud-run-using-terraform-ee8ae4ecb72e">Tutorial Serverless Deployment on Cloud Run using Terraform</a> y <a href="https://www.sethvargo.com/configuring-cloud-run-with-terraform/">Configuring Cloud Run with Terraform</a></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Actualmente, el provider para Cloud Run sólo permite acceso al puerto 8080 del contenedor. Por tanto, las imágenes Docker tienen que servir su contenido a través de ese puerto para un despliegue en Cloud Run desde Terraform.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/azure/developer/terraform/">Terraform on Azure documentation</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/azure/virtual-machines/linux/quick-create-terraform?tabs=azure-cli">Quickstart: Use Terraform to create a Linux VM</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusiones">6. Conclusiones</h2>
<div class="sectionbody">
<div class="paragraph">
<p>En este tutorial hemos visto cómo usar Terraform para desplegar infraestructura en la nube en diferentes proveedores. Hemos visto cómo configurar Terraform para trabajar con los proveedores y cómo crear configuraciones para desplegar recursos en la nube. Hemos visto cómo crear instancias, redes, volúmenes, direcciones IP, etc. en los proveedores OpenStack, Google Cloud y Microsoft Azure. Básicamente, hemos desarrollado un ejemplo de preparación de la infraestructura de red y de despliegue de una instancia con un servidor web Apache en cada uno de los proveedores. Esto nos ha permitido ver las similitudes en la conceptualización en el proceso de despliegue de infraestructura en la nube en diferentes proveedores así como las diferencias en la configuración de los recursos en cada uno de ellos.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-10-11 19:16:07 +0200
</div>
</div>
</body>
</html>